{% extends 'dashboard/base.html' %}
{% load static %}
{% block title %}LIVE THREAT FEED{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h2 class="text-4xl font-bold text-cyan-300 text-center mb-12 tracking-widest animate-pulse">
        LIVE THREAT FEED
    </h2>

    <!-- CHART -->
    <div class="chart-container glass mx-auto mb-12">
        <canvas id="chart"></canvas>
    </div>

    <!-- ALERTS -->
    <div class="space-y-6 max-w-4xl mx-auto">
        {% for alert in alerts %}
        <div class="glass p-6 severity-{{ alert.severity|lower }} transform transition-all hover:scale-105 hover:shadow-2xl">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h3 class="text-2xl font-bold flex items-center gap-3">
                        <span class="inline-block px-4 py-2 rounded-lg font-bold text-lg shadow-lg
                            {% if alert.severity == 'Critical' %}
                                text-red-400 bg-red-900/60 shadow-red-500/60 animate-pulse
                            {% elif alert.severity == 'High' %}
                                text-orange-400 bg-orange-900/60 shadow-orange-500/50 animate-pulse-fast
                            {% elif alert.severity == 'Medium' %}
                                text-yellow-400 bg-yellow-900/40 shadow-yellow-500/40
                            {% else %}
                                text-green-400 bg-green-900/40 shadow-green-500/40
                            {% endif %}">
                            [{{ alert.severity|upper }}]
                        </span>
                        <span class="text-cyan-300">{{ alert.title }}</span>
                    </h3>
                    <p class="mt-3 text-gray-300 text-lg leading-relaxed">{{ alert.description }}</p>
                    <p class="text-sm text-gray-400 mt-5 flex flex-wrap items-center gap-3">
                        <span class="terminal">By: {{ alert.reported_by }}</span> |
                        <span>{{ alert.date_reported|date:"M d, Y H:i:s" }}</span>
                        {% if alert.source_ip %}
                        | <span class="text-orange-400 font-mono">{{ alert.source_ip }}</span>
                        {% endif %}
                    </p>
                </div>

                <!-- DELETE BUTTON (ONLY FOR ADMIN) -->
                {% if user.is_superuser %}
                <div class="ml-4">
                    <form method="post" action="{% url 'delete_alert' alert.id %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" 
                                class="text-red-400 hover:text-red-300 text-xs font-bold uppercase tracking-wider 
                                       hover:underline transition-all"
                                onclick="return confirm('Delete this alert?')">
                            Delete
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="glass p-12 text-center">
            <p class="text-cyan-400 text-2xl">All systems nominal. No active threats.</p>
        </div>
        {% endfor %}
    </div>

    <div class="text-center mt-12">
        <a href="/" class="text-cyan-400 hover:underline text-lg">Back to Command Center</a>
    </div>
</div>

<!-- CHART JS -->
<script>
    const ctx = document.getElementById('chart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Critical', 'High', 'Medium', 'Low'],
            datasets: [{
                data: [{{ critical }}, {{ high }}, {{ medium }}, {{ low }}],
                backgroundColor: ['#ff3366', '#ffaa00', '#ffff00', '#00ff88'],
                borderColor: ['#ff3366', '#ffaa00', '#ffff00', '#00ff88'],
                borderWidth: 4,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            cutout: '65%',
            plugins: {
                legend: { position: 'bottom', labels: { color: '#e0f7ff', font: { size: 14 } } },
                title: { display: true, text: 'THREAT SEVERITY MATRIX', color: '#00d4ff', font: { size: 18, family: 'Orbitron' } }
            }
        }
    });
</script>

<!-- MAP -->
<div class="glass p-8 mt-10">
    <h3 class="text-2xl font-bold text-cyan-300 text-center mb-6 tracking-wider">
        GLOBAL THREAT MAP
    </h3>
    <div id="world-map" style="height: 500px; border-radius: 16px;"></div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const map = L.map('world-map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    const severityColors = {
        'Critical': '#ef4444',
        'High': '#f97316',
        'Medium': '#eab308',
        'Low': '#22c55e'
    };

    {% for alert in alerts %}
        {% if alert.latitude and alert.longitude %}
            var marker = L.circleMarker([{{ alert.latitude }}, {{ alert.longitude }}], {
                radius: 8,
                fillColor: severityColors['{{ alert.severity }}'],
                color: '#000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);
            marker.bindPopup(`
                <b>{{ alert.title }}</b><br>
                <b>Severity:</b> {{ alert.severity }}<br>
                <b>IP:</b> {{ alert.source_ip }}<br>
                <b>Location:</b> {{ alert.city|default:"Unknown" }}, {{ alert.country|default:"Unknown" }}
            `);
        {% endif %}
    {% endfor %}
</script>

{% endblock %}

